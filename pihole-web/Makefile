include $(TOPDIR)/rules.mk

PKG_NAME:=pihole-web
PKG_VERSION:=5.11
PKG_RELEASE:=2

PKG_SOURCE_URL:=https://codeload.github.com/pi-hole/AdminLTE/tar.gz/v$(PKG_VERSION)?
PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
PKG_HASH:=589ef049135a90d622fc68299140e4dc16451ce541b804b35ffa5d25201afeb4
PKG_BUILD_DIR:=$(BUILD_DIR)/AdminLTE-$(PKG_VERSION)

PKG_LICENSE:=EUPL
PKG_LICENSE_FILES:=LICENSE

include $(INCLUDE_DIR)/package.mk

define Package/pihole-web
  SECTION:=regae
  CATEGORY:=regae
  TITLE:=Pi-hole Dashboard for stats and more
  URL:=https://pi-hole.net/
  DEPENDS:=pihole +sudo +lighttpd +lighttpd-mod-access +lighttpd-mod-fastcgi +lighttpd-mod-setenv +php7 +php7-cgi +php7-mod-json +php7-mod-openssl +php7-mod-phar +php7-mod-session +php7-mod-sqlite3 +php7-mod-intl +php7-mod-xml +php7-mod-filter +zoneinfo-asia
endef

define Package/pihole-web/description
  Pi-hole®'s Web interface (based off of AdminLTE) provides a central location to manage your Pi-hole and review the statistics generated by FTLDNS™.
endef

define Build/Compile
endef

define Package/pihole-web/install
	$(INSTALL_DIR) $(1)/etc/lighttpd/conf.d
	$(INSTALL_DATA) ./files/lighttpd.conf $(1)/etc/lighttpd/conf.d/99-pihole.conf
	$(INSTALL_DIR) $(1)/etc/sudoers.d
	$(INSTALL_DATA) ./files/pihole.sudo $(1)/etc/sudoers.d/pihole
	$(INSTALL_DIR) $(1)/srv/www
	$(INSTALL_DIR) $(1)/srv/www/admin
	$(CP) -r $(PKG_BUILD_DIR)/{img,scripts,style,*.php} $(1)/srv/www/admin/
	$(RM) -f $(1)/srv/www/admin/scripts/pi-hole/js/debug.js
	$(RM) -f $(1)/srv/www/admin/scripts/pi-hole/php/debug.php
	$(RM) -f $(1)/srv/www/admin/scripts/pi-hole/php/teleporter.php
	$(INSTALL_DIR) $(1)/srv/www/pihole
	$(INSTALL_DATA) ./files/blockingpage.css $(1)/srv/www/pihole/
	$(INSTALL_DATA) ./files/index.php $(1)/srv/www/pihole/
	$(INSTALL_DIR) $(1)/usr/share/acl.d
	$(INSTALL_DATA) ./files/pihole_web.json $(1)/usr/share/acl.d
endef

define Package/pihole-web/postinst
#!/usr/bin/env bash
# check if we are on real system
if [ -z "$${IPKG_INSTROOT}" ]; then
	echo "commenting server.document-root"
	sed -i 's/server.document-root/#server.document-root/g' /etc/lighttpd/lighttpd.conf
	echo "changing php doc_root"
	sed -i "s!doc_root = \"/www\"!doc_root = \"/srv/www\"!g" /etc/php.ini
fi
exit 0
endef

define Package/pihole-web/prerm
#!/usr/bin/env bash
# check if we are on real system
if [ -z "$${IPKG_INSTROOT}" ]; then
	echo "uncommenting server.document-root"
	sed -i 's/#server.document-root/server.document-root/g' /etc/lighttpd/lighttpd.conf
	echo "changing php doc_root"
	sed -i "s!doc_root = \"/srv/www\"!doc_root = \"/www\"!g" /etc/php.ini
fi
exit 0
endef

$(eval $(call BuildPackage,pihole-web))
